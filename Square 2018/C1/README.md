C1: dot-n-dash
==============

Category: programming

Statement
---------

The instructions to disable C1 were considered restricted. As a result, they were stored only in encoded form.

The code to decode the instructions was regrettably lost due to cosmic radiation. However, the [encoder survived](https://2018.squarectf.com/puzzles/c1_be8a91e0a0e8966d7d58/dot-n-dash.jar).

Can you still decode the instructions to disable C1?

note: all the files we provide are compressed using ```jar```. You should be able to decompress them on a command line (e.g. ```jar xf dot-n-dash.jar```) or using a graphical decompression tool.

Your browser may warn you that "this type of file can harm your computer" because jar files typically contain Java code.

Solution
--------

We are given a html file of an encryption/decryption service (written in js) and file containing encoded instructions. Inspecting the html code we can find that the decrypting function is missing. So our task here will consist of two parts: first we must understand the encryption code and then we must write our own decrypting function.

Here is the encrypting function:

```javascript
function _encode(input) {
  var a=[];
  for (var i=0; i<input.length; i++) {
    var t = input.charCodeAt(i);
    for (var j=0; j<8; j++) {
      if ((t >> j) & 1) {
        a.push(1 + j + (input.length - 1 - i) * 8);
      }
    }
  }

  var b = [];
  while (a.length) {
    var t = (Math.random() * a.length)|0;
    b.push(a[t]);
    a = a.slice(0, t).concat(a.slice(t+1));
  }

  var r = '';
  while (b.length) {
    var t = b.pop();
    r = r + "-".repeat(t) + ".";
  }
  return r;
}
```

The code consists of three parts: create array ```a``` using input, create array ```b``` using array ```a``` and create output using array ```b```.
The first array is created in a following manner: the function iterates over characters in our input and calculates positions of bits that are on in the binary representation of character ascii code. Then for every such bit it appends ```position of bit + 8 * position of character in string``` to the array. To better understand how the function is working you can simply put ```return a``` after the first for loop then open the web page and see what happens after inputing some data.

The construction of ```b``` array looks very confusing. Instead of trying to figure out what's going on, I simply put ```return b``` after the while loop and looked at the outputs generated by function. It looks like the function is simply permutating array ```a``` randomly, so it shouldn't be important at all.

The last part is very straightforward - for every number x in array ```b``` append x dashes followed by a single dot.

Now we are ready to create our own decoding function. Also, trying to implement it in our html file in order to run it and paste content of instructions.txt into to text box is a bad idea, as the file is very big and it will probably freeze your browser. I wrote my decoding script in python. Here is its code:

```python
input = #pasted the instructions.txt file here
list = input.split('.') #split the input into dashes-only sequences
bignum = 0
for s in list:
    if len(s) > 0:
        bignum += (1 << (len(s) - 1)) #length of dash sequence indicates the value in array b

out = ""
print(bignum)
while bignum > 0:
    out += chr(bignum % 256) #take last 8 bytes and turn them into char
    bignum = bignum // 256

print(out[::-1]) #we have to reverse the output
```

The flag is contained in the decoded instructions.
